{% extends 'admin_dashboard/base_admin.html' %}
{% load humanize %}

{% block title %}Subscription Payments Management{% endblock %}
{% block page_title %}Subscription Payments{% endblock %}

{% block content %}
<!-- Header Section -->
<div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(0, 217, 255, 0.1) 100%); border-radius: 20px; padding: 32px; margin-bottom: 32px; border: 2px solid rgba(168, 85, 247, 0.3); box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(0, 217, 255, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
    <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;">
        <div>
            <h2 style="color: #A855F7; font-weight: 900; font-size: 32px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(168, 85, 247, 0.4);">
                <i class="fas fa-receipt me-3" style="color: var(--neon-cyan);"></i>Subscription Payments
            </h2>
            <p style="color: rgba(224, 231, 255, 0.8); font-size: 16px; margin: 0;">
                Track and manage all subscription payment transactions
            </p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{% url 'admin_dashboard:subscription_users' %}" style="background: linear-gradient(135deg, #A855F7, #9333EA); color: white; border: none; font-weight: 700; padding: 12px 24px; border-radius: 12px; text-decoration: none; display: inline-flex; align-items: center; box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(168, 85, 247, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(168, 85, 247, 0.4)';">
                <i class="fas fa-users me-2"></i> Subscriptions
            </a>
            <a href="{% url 'admin_dashboard:dashboard' %}" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border: none; font-weight: 700; padding: 12px 24px; border-radius: 12px; text-decoration: none; display: inline-flex; align-items: center; box-shadow: 0 8px 20px rgba(0, 217, 255, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(0, 217, 255, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(0, 217, 255, 0.4)';">
                <i class="fas fa-arrow-left me-2"></i> Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Statistics Cards - Modern Responsive Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <!-- Total Payments Card -->
    <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(79, 70, 229, 0.1)); border: 2px solid rgba(99, 102, 241, 0.3); border-radius: 20px; padding: 28px; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2); position: relative; overflow: hidden; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(99, 102, 241, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(99, 102, 241, 0.2)';">
        <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: radial-gradient(circle, rgba(99, 102, 241, 0.2), transparent); border-radius: 50%;"></div>
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; position: relative; z-index: 1;">
            <h6 style="color: rgba(224, 231, 255, 0.8); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Total Payments</h6>
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #6366F1, #4F46E5); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);">
                <i class="fas fa-receipt" style="font-size: 20px; color: white;"></i>
            </div>
        </div>
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 42px; font-weight: 900; color: #6366F1; margin-bottom: 8px; text-shadow: 0 0 20px rgba(99, 102, 241, 0.3);">{{ stats.total_payments|intcomma }}</div>
            <p style="color: rgba(224, 231, 255, 0.6); font-size: 13px; margin: 0;">All payments</p>
        </div>
    </div>

    <!-- Completed Payments Card -->
    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.1)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 20px; padding: 28px; box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2); position: relative; overflow: hidden; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(34, 197, 94, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(34, 197, 94, 0.2)';">
        <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: radial-gradient(circle, rgba(34, 197, 94, 0.2), transparent); border-radius: 50%;"></div>
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; position: relative; z-index: 1;">
            <h6 style="color: rgba(224, 231, 255, 0.8); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Completed</h6>
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #22C55E, #16A34A); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);">
                <i class="fas fa-check-circle" style="font-size: 20px; color: white;"></i>
            </div>
        </div>
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 42px; font-weight: 900; color: #22C55E; margin-bottom: 8px; text-shadow: 0 0 20px rgba(34, 197, 94, 0.3);">{{ stats.completed_payments|intcomma }}</div>
            <p style="color: rgba(224, 231, 255, 0.6); font-size: 13px; margin: 0;">Completed payments</p>
        </div>
    </div>

    <!-- Pending Payments Card -->
    <div style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.15), rgba(249, 115, 22, 0.1)); border: 2px solid rgba(251, 146, 60, 0.3); border-radius: 20px; padding: 28px; box-shadow: 0 10px 30px rgba(251, 146, 60, 0.2); position: relative; overflow: hidden; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(251, 146, 60, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(251, 146, 60, 0.2)';">
        <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: radial-gradient(circle, rgba(251, 146, 60, 0.2), transparent); border-radius: 50%;"></div>
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; position: relative; z-index: 1;">
            <h6 style="color: rgba(224, 231, 255, 0.8); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Pending</h6>
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #FB923C, #F97316); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(251, 146, 60, 0.4);">
                <i class="fas fa-clock" style="font-size: 20px; color: white;"></i>
            </div>
        </div>
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 42px; font-weight: 900; color: #FB923C; margin-bottom: 8px; text-shadow: 0 0 20px rgba(251, 146, 60, 0.3);">{{ stats.pending_payments|intcomma }}</div>
            <p style="color: rgba(224, 231, 255, 0.6); font-size: 13px; margin: 0;">Pending payments</p>
        </div>
    </div>

    <!-- Total Revenue Card -->
    <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(147, 51, 234, 0.1)); border: 2px solid rgba(168, 85, 247, 0.3); border-radius: 20px; padding: 28px; box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2); position: relative; overflow: hidden; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(168, 85, 247, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(168, 85, 247, 0.2)';">
        <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: radial-gradient(circle, rgba(168, 85, 247, 0.2), transparent); border-radius: 50%;"></div>
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; position: relative; z-index: 1;">
            <h6 style="color: rgba(224, 231, 255, 0.8); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Total Revenue</h6>
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #A855F7, #9333EA); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4);">
                <i class="fas fa-coins" style="font-size: 20px; color: white;"></i>
            </div>
        </div>
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 32px; font-weight: 900; color: #A855F7; margin-bottom: 8px; text-shadow: 0 0 20px rgba(168, 85, 247, 0.3);">{{ stats.total_revenue|floatformat:0|intcomma }} RWF</div>
            <p style="color: rgba(224, 231, 255, 0.6); font-size: 13px; margin: 0;">Total revenue</p>
        </div>
    </div>
</div>

<!-- Monthly Revenue Highlight Card -->
<div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.15)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 20px; padding: 36px; margin-bottom: 32px; box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3); position: relative; overflow: hidden; text-align: center;">
    <div style="position: absolute; top: -80px; right: -80px; width: 250px; height: 250px; background: radial-gradient(circle, rgba(34, 197, 94, 0.3), transparent); border-radius: 50%;"></div>
    <div style="position: relative; z-index: 1;">
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #22C55E, #16A34A); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 12px 30px rgba(34, 197, 94, 0.5); margin-right: 20px;">
                <i class="fas fa-chart-line" style="font-size: 28px; color: white;"></i>
            </div>
            <h5 style="color: rgba(224, 231, 255, 0.9); font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0;">Monthly Revenue</h5>
        </div>
        <div style="font-size: 56px; font-weight: 900; color: #22C55E; margin-bottom: 12px; text-shadow: 0 0 30px rgba(34, 197, 94, 0.5);">{{ stats.monthly_revenue|floatformat:0|intcomma }} RWF</div>
        <p style="color: rgba(224, 231, 255, 0.7); font-size: 15px; margin: 0;">Revenue from subscription payments this month</p>
    </div>
</div>

<!-- Filters Section -->
<div style="background: linear-gradient(135deg, rgba(26, 31, 58, 0.9) 0%, rgba(10, 14, 39, 0.95) 100%); border-radius: 16px; padding: 28px; margin-bottom: 32px; box-shadow: 0 0 40px rgba(0, 217, 255, 0.25), inset 0 0 20px rgba(0, 217, 255, 0.08); border: 1px solid var(--neon-blue); border-left: 5px solid var(--neon-cyan);">
    <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
        <h5 style="color: var(--neon-cyan); font-weight: 800; font-size: 18px; margin: 0; text-shadow: 0 0 15px rgba(0, 217, 255, 0.6); letter-spacing: 0.5px;">
            <i class="fas fa-search me-2"></i>Search & Filter Payments
        </h5>
        <span style="background: rgba(0, 217, 255, 0.15); color: var(--neon-cyan); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; border: 1px solid rgba(0, 217, 255, 0.3);">
            <i class="fas fa-filter me-1"></i>Advanced Filters
        </span>
    </div>
    
    <form method="get" class="row g-3">
        <div class="col-lg-4 col-md-6">
            <label style="display: block; font-size: 12px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; text-shadow: 0 0 10px rgba(0, 217, 255, 0.4);">
                <i class="fas fa-search me-1"></i>Search
            </label>
            <input type="text" class="form-control" name="search" value="{{ search_query }}" placeholder="Username, email, transaction..."
                   style="background: rgba(10, 14, 39, 0.8); border: 2px solid var(--neon-blue); color: var(--neon-cyan); font-weight: 500; padding: 12px 16px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 217, 255, 0.15); transition: all 0.3s ease;"
                   onfocus="this.style.boxShadow='0 0 25px rgba(0, 217, 255, 0.4)'; this.style.borderColor='var(--neon-cyan)';"
                   onblur="this.style.boxShadow='0 0 15px rgba(0, 217, 255, 0.15)'; this.style.borderColor='var(--neon-blue)';">
        </div>
        <div class="col-lg-3 col-md-6">
            <label style="display: block; font-size: 12px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; text-shadow: 0 0 10px rgba(0, 217, 255, 0.4);">
                <i class="fas fa-check-circle me-1"></i>Status
            </label>
            <select class="form-select" name="status"
                    style="background: rgba(10, 14, 39, 0.8); border: 2px solid var(--neon-blue); color: var(--neon-cyan); font-weight: 500; padding: 12px 16px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 217, 255, 0.15); transition: all 0.3s ease;"
                    onfocus="this.style.boxShadow='0 0 25px rgba(0, 217, 255, 0.4)'; this.style.borderColor='var(--neon-cyan)';"
                    onblur="this.style.boxShadow='0 0 15px rgba(0, 217, 255, 0.15)'; this.style.borderColor='var(--neon-blue)';">
                <option value="" style="background: #0A0E27; color: var(--neon-cyan);">All Statuses</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %} style="background: #0A0E27; color: var(--neon-cyan);">Completed</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %} style="background: #0A0E27; color: var(--neon-cyan);">Pending</option>
                <option value="failed" {% if status_filter == 'failed' %}selected{% endif %} style="background: #0A0E27; color: var(--neon-cyan);">Failed</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6">
            <label style="display: block; font-size: 12px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; text-shadow: 0 0 10px rgba(0, 217, 255, 0.4);">
                <i class="fas fa-calendar me-1"></i>Date
            </label>
            <input type="date" class="form-control" name="date" value="{{ date_filter }}"
                   style="background: rgba(10, 14, 39, 0.8); border: 2px solid var(--neon-blue); color: var(--neon-cyan); font-weight: 500; padding: 12px 16px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 217, 255, 0.15); transition: all 0.3s ease;"
                   onfocus="this.style.boxShadow='0 0 25px rgba(0, 217, 255, 0.4)'; this.style.borderColor='var(--neon-cyan)';"
                   onblur="this.style.boxShadow='0 0 15px rgba(0, 217, 255, 0.15)'; this.style.borderColor='var(--neon-blue)';">
        </div>
        <div class="col-lg-3 col-md-6">
            <label style="display: block; font-size: 12px; font-weight: 700; color: transparent; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Action</label>
            <div class="d-flex gap-2">
                <button type="submit" class="btn flex-grow-1" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border: none; font-weight: 700; padding: 12px 20px; border-radius: 10px; box-shadow: 0 0 25px rgba(0, 217, 255, 0.4); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 35px rgba(0, 217, 255, 0.6)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 25px rgba(0, 217, 255, 0.4)';">
                    <i class="fas fa-search me-2"></i>Search
                </button>
                <a href="{% url 'admin_dashboard:subscription_payments' %}" class="btn" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; font-weight: 700; padding: 12px 20px; border-radius: 10px; box-shadow: 0 0 25px rgba(239, 68, 68, 0.4); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; text-decoration: none;"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 35px rgba(239, 68, 68, 0.6)';"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 25px rgba(239, 68, 68, 0.4)';">
                    <i class="fas fa-times me-2"></i>Clear
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Payments Table -->
<div style="background: linear-gradient(135deg, rgba(26, 31, 58, 0.95) 0%, rgba(10, 14, 39, 0.98) 100%); border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 217, 255, 0.3); border: 2px solid rgba(0, 217, 255, 0.2);">
    <div style="background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(168, 85, 247, 0.15)); padding: 24px; border-bottom: 2px solid rgba(0, 217, 255, 0.3);">
        <h5 style="color: var(--neon-cyan); font-weight: 800; font-size: 20px; margin: 0; text-shadow: 0 0 15px rgba(0, 217, 255, 0.6);">
            <i class="fas fa-list me-2"></i>Payment Transactions
            {% if page_obj.paginator.count %}
                <span style="color: #A855F7; font-size: 18px;">({{ page_obj.paginator.count|intcomma }} total)</span>
            {% endif %}
        </h5>
    </div>
            
    {% if page_obj %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead style="background: rgba(0, 217, 255, 0.1); border-bottom: 2px solid rgba(0, 217, 255, 0.3);">
                <tr>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Transaction</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">User</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Amount</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Status</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Date</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in page_obj %}
                <tr style="border-bottom: 1px solid rgba(0, 217, 255, 0.1); transition: all 0.3s ease;" onmouseover="this.style.background='rgba(0, 217, 255, 0.05)';" onmouseout="this.style.background='transparent';">
                    <td style="padding: 18px 20px; border: none;">
                        <div>
                            <div style="font-weight: 800; font-family: monospace; color: var(--neon-cyan); font-size: 15px; text-shadow: 0 0 10px rgba(0, 217, 255, 0.3);">
                                #{{ payment.transaction_id|default:payment.id }}
                            </div>
                            {% if payment.subscription %}
                                <small style="color: rgba(224, 231, 255, 0.5); font-size: 12px;">{{ payment.subscription.plan.display_name }}</small>
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <div class="d-flex align-items-center">
                            <div class="me-3" style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);">
                                {{ payment.subscription.user.username|first|upper }}
                            </div>
                            <div>
                                <div style="font-weight: 700; color: rgba(224, 231, 255, 0.95); font-size: 14px;">{{ payment.subscription.user.username }}</div>
                                <small style="color: rgba(224, 231, 255, 0.5); font-size: 12px;">{{ payment.subscription.user.email|truncatechars:25 }}</small>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <div style="font-size: 20px; font-weight: 900; color: #FB923C; text-shadow: 0 0 10px rgba(251, 146, 60, 0.3);">
                            {{ payment.amount|floatformat:0|intcomma }} RWF
                        </div>
                        {% if payment.currency and payment.currency != 'RWF' %}
                            <small style="color: rgba(224, 231, 255, 0.5); font-size: 11px;">{{ payment.currency }}</small>
                        {% endif %}
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <span style="background: {% if payment.status == 'completed' %}rgba(34, 197, 94, 0.2){% elif payment.status == 'pending' %}rgba(251, 146, 60, 0.2){% else %}rgba(239, 68, 68, 0.2){% endif %}; 
                                    color: {% if payment.status == 'completed' %}#22C55E{% elif payment.status == 'pending' %}#FB923C{% else %}#EF4444{% endif %}; 
                                    padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; border: 1px solid {% if payment.status == 'completed' %}rgba(34, 197, 94, 0.4){% elif payment.status == 'pending' %}rgba(251, 146, 60, 0.4){% else %}rgba(239, 68, 68, 0.4){% endif %};">
                            {{ payment.status|title }}
                        </span>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <div style="color: rgba(224, 231, 255, 0.9); font-size: 14px; font-weight: 600;">{{ payment.created_at|date:"M d, Y" }}</div>
                        <small style="color: rgba(224, 231, 255, 0.5); font-size: 12px;">{{ payment.created_at|time:"H:i" }}</small>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <div class="d-flex gap-2">
                            <button onclick="viewPaymentDetails({{ payment.id }})" style="background: linear-gradient(135deg, #6366F1, #4F46E5); color: white; border: none; font-weight: 700; padding: 8px 12px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)';" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="/admin/payments/subscriptionpayment/{{ payment.id }}/change/" target="_blank" style="background: linear-gradient(135deg, #A855F7, #9333EA); color: white; border: none; font-weight: 700; padding: 8px 12px; border-radius: 8px; text-decoration: none; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); transition: all 0.3s ease; display: inline-flex; align-items: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(168, 85, 247, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(168, 85, 247, 0.3)';" title="Edit Payment">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if payment.subscription %}
                            <a href="{% url 'admin_dashboard:users_management' %}?search={{ payment.subscription.user.username }}" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border: none; font-weight: 700; padding: 8px 12px; border-radius: 8px; text-decoration: none; box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3); transition: all 0.3s ease; display: inline-flex; align-items: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 217, 255, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 217, 255, 0.3)';" title="View User">
                                <i class="fas fa-user"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="p-3" style="background: rgba(212, 175, 55, 0.05); border-radius: 0 0 12px 12px;">
                <nav aria-label="Payments pagination">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if date_filter %}date={{ date_filter }}&{% endif %}page={{ page_obj.previous_page_number }}" style="color: var(--chocolate-dark);">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link" style="background: var(--gold); border-color: var(--gold); color: var(--chocolate-dark);">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if date_filter %}date={{ date_filter }}&{% endif %}page={{ num }}" style="color: var(--chocolate-dark);">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if date_filter %}date={{ date_filter }}&{% endif %}page={{ page_obj.next_page_number }}" style="color: var(--chocolate-dark);">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <div class="text-center p-5">
                <i class="fas fa-receipt fa-3x mb-3" style="color: var(--gold);"></i>
                <h5 style="color: var(--chocolate-dark);">No payments found</h5>
                <p class="text-muted">
                    {% if search_query or status_filter or date_filter %}
                        No payments match your current filters.
                    {% else %}
                        No subscription payments have been processed yet.
                    {% endif %}
                </p>
                {% if search_query or status_filter or date_filter %}
                <a href="{% url 'admin_dashboard:subscription_payments' %}" class="btn" style="background: var(--gold); color: var(--chocolate-dark); border: none; font-weight: bold; padding: 10px 20px; border-radius: 6px;">
                    <i class="fas fa-times me-1"></i> Clear Filters
                </a>
                {% endif %}
            </div>
            {% endif %}
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentDetailsModal" tabindex="-1" aria-labelledby="paymentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: linear-gradient(135deg, rgba(26, 31, 58, 0.98) 0%, rgba(10, 14, 39, 0.98) 100%); border: 2px solid rgba(0, 217, 255, 0.3); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="border-bottom: 2px solid rgba(0, 217, 255, 0.3); padding: 24px;">
                <h5 class="modal-title" id="paymentDetailsModalLabel" style="color: var(--neon-cyan); font-weight: 800; font-size: 24px; text-shadow: 0 0 15px rgba(0, 217, 255, 0.6);">
                    <i class="fas fa-receipt me-2"></i>Payment Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1) opacity(0.8);"></button>
            </div>
            <div class="modal-body" id="paymentDetailsContent" style="padding: 28px;">
                <div class="text-center py-5">
                    <div class="spinner-border" style="color: var(--neon-cyan); width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p style="color: rgba(224, 231, 255, 0.7); margin-top: 16px;">Loading payment details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function viewPaymentDetails(paymentId) {
    console.log('viewPaymentDetails called with ID:', paymentId);
    
    const modal = new bootstrap.Modal(document.getElementById('paymentDetailsModal'));
    const contentDiv = document.getElementById('paymentDetailsContent');
    
    // Show loading state
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border" style="color: var(--neon-cyan); width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p style="color: rgba(224, 231, 255, 0.7); margin-top: 16px;">Loading payment details...</p>
        </div>
    `;
    
    modal.show();
    
    const url = `/admin-dashboard/api/payment-details/${paymentId}/`;
    console.log('Fetching from URL:', url);
    
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.querySelector('meta[name="csrf-token"]')?.content ||
                      getCookie('csrftoken');
    
    console.log('CSRF token:', csrftoken ? 'Found' : 'Not found');
    
    // Fetch payment details
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
        },
        credentials: 'same-origin'
    })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Error response body:', text);
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.error) {
                contentDiv.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x mb-3" style="color: #EF4444;"></i>
                        <h5 style="color: rgba(224, 231, 255, 0.9);">Error Loading Payment</h5>
                        <p style="color: rgba(224, 231, 255, 0.6);">${data.error}</p>
                    </div>
                `;
                return;
            }
            
            const statusColor = data.status === 'completed' ? '#22C55E' : data.status === 'pending' ? '#FB923C' : '#EF4444';
            const statusBg = data.status === 'completed' ? 'rgba(34, 197, 94, 0.2)' : data.status === 'pending' ? 'rgba(251, 146, 60, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            
            contentDiv.innerHTML = `
                <div class="row g-4">
                    <!-- Transaction Info Card -->
                    <div class="col-md-6">
                        <div style="background: rgba(0, 217, 255, 0.1); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 16px; padding: 24px;">
                            <h6 style="color: var(--neon-cyan); font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px;">
                                <i class="fas fa-info-circle me-2"></i>Transaction Information
                            </h6>
                            <div class="mb-3">
                                <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Transaction ID</small>
                                <div style="color: var(--neon-cyan); font-weight: 800; font-family: monospace; font-size: 16px;">#${data.transaction_id}</div>
                            </div>
                            <div class="mb-3">
                                <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Amount</small>
                                <div style="color: #FB923C; font-weight: 900; font-size: 24px;">${data.amount} ${data.currency}</div>
                            </div>
                            <div class="mb-3">
                                <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Status</small>
                                <span style="background: ${statusBg}; color: ${statusColor}; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; border: 1px solid ${statusColor}40; display: inline-block;">
                                    ${data.status}
                                </span>
                            </div>
                            ${data.payment_method ? `
                            <div class="mb-3">
                                <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Payment Method</small>
                                <div style="color: rgba(224, 231, 255, 0.9); font-weight: 600;">${data.payment_method}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- User & Subscription Info Card -->
                    <div class="col-md-6">
                        <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 16px; padding: 24px;">
                            <h6 style="color: #A855F7; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px;">
                                <i class="fas fa-user me-2"></i>User & Subscription
                            </h6>
                            ${data.user ? `
                            <div class="mb-3">
                                <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">User</small>
                                <div style="color: rgba(224, 231, 255, 0.95); font-weight: 700; font-size: 15px;">${data.user.username}</div>
                                <div style="color: rgba(224, 231, 255, 0.6); font-size: 13px;">${data.user.email}</div>
                            </div>
                            ` : ''}
                            ${data.plan ? `
                            <div class="mb-3">
                                <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Subscription Plan</small>
                                <div style="color: #A855F7; font-weight: 700; font-size: 15px;">${data.plan.name}</div>
                                <div style="color: rgba(224, 231, 255, 0.6); font-size: 13px;">${data.plan.price} RWF/${data.plan.billing_cycle}</div>
                            </div>
                            ` : ''}
                            ${data.subscription_status ? `
                            <div class="mb-3">
                                <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Subscription Status</small>
                                <div style="color: rgba(224, 231, 255, 0.9); font-weight: 600;">${data.subscription_status}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Date Information Card -->
                    <div class="col-12">
                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 24px;">
                            <h6 style="color: #22C55E; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px;">
                                <i class="fas fa-calendar me-2"></i>Date Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Created At</small>
                                    <div style="color: rgba(224, 231, 255, 0.9); font-weight: 600;">${data.created_at}</div>
                                </div>
                                ${data.updated_at ? `
                                <div class="col-md-6 mb-3">
                                    <small style="color: rgba(224, 231, 255, 0.6); font-size: 12px; display: block; margin-bottom: 6px;">Last Updated</small>
                                    <div style="color: rgba(224, 231, 255, 0.9); font-weight: 600;">${data.updated_at}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${data.notes ? `
                    <!-- Notes Card -->
                    <div class="col-12">
                        <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 24px;">
                            <h6 style="color: #6366F1; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;">
                                <i class="fas fa-sticky-note me-2"></i>Notes
                            </h6>
                            <div style="color: rgba(224, 231, 255, 0.8); line-height: 1.6;">${data.notes}</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-4 d-flex gap-2 justify-content-end">
                    <a href="/admin/payments/subscriptionpayment/${paymentId}/change/" target="_blank" class="btn" style="background: linear-gradient(135deg, #A855F7, #9333EA); color: white; border: none; font-weight: 700; padding: 12px 24px; border-radius: 12px; box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);">
                        <i class="fas fa-edit me-2"></i>Edit Payment
                    </a>
                    ${data.user ? `
                    <a href="/admin-dashboard/users/?search=${data.user.username}" class="btn" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border: none; font-weight: 700; padding: 12px 24px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 217, 255, 0.4);">
                        <i class="fas fa-user me-2"></i>View User
                    </a>
                    ` : ''}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching payment details:', error);
            console.error('Error stack:', error.stack);
            contentDiv.innerHTML = `
                <div class="py-4">
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error Loading Payment Details</strong>
                        <hr>
                        <p class="mb-2"><strong>Error Message:</strong> ${error.message}</p>
                        <p class="mb-2"><strong>URL Attempted:</strong> ${url}</p>
                        <p class="mb-0"><small>Check the browser console (F12) for more details.</small></p>
                    </div>
                </div>
            `;
        });
}

// Helper function to get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

console.log('Payment details script loaded successfully');

</script>
{% endblock %}