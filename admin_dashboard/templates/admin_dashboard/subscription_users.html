{% extends 'admin_dashboard/base_admin.html' %}
{% load humanize %}

{% block title %}User Subscriptions Management{% endblock %}
{% block page_title %}User Subscriptions{% endblock %}

{% block content %}
<!-- Header Section -->
<div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(0, 217, 255, 0.1) 100%); border-radius: 20px; padding: 32px; margin-bottom: 32px; border: 2px solid rgba(168, 85, 247, 0.3); box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(0, 217, 255, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
    <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;">
        <div>
            <h2 style="color: #A855F7; font-weight: 900; font-size: 32px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(168, 85, 247, 0.4);">
                <i class="fas fa-crown me-3" style="color: var(--neon-cyan);"></i>User Subscriptions
            </h2>
            <p style="color: rgba(224, 231, 255, 0.8); font-size: 16px; margin: 0;">
                Manage and monitor all active user subscriptions on your platform
            </p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{% url 'admin_dashboard:subscription_plans' %}" style="background: linear-gradient(135deg, #A855F7, #9333EA); color: white; border: none; font-weight: 700; padding: 12px 24px; border-radius: 12px; text-decoration: none; display: inline-flex; align-items: center; box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(168, 85, 247, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(168, 85, 247, 0.4)';">
                <i class="fas fa-layer-group me-2"></i> Plans
            </a>
            <a href="{% url 'admin_dashboard:dashboard' %}" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border: none; font-weight: 700; padding: 12px 24px; border-radius: 12px; text-decoration: none; display: inline-flex; align-items: center; box-shadow: 0 8px 20px rgba(0, 217, 255, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(0, 217, 255, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(0, 217, 255, 0.4)';">
                <i class="fas fa-arrow-left me-2"></i> Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Statistics Cards - Modern Responsive Grid -->
<div class="dashboard-grid mb-4">
    <div class="dashboard-card card-warning">
        <div class="dashboard-card-header">
            <h4 class="dashboard-card-title">Total</h4>
            <div class="dashboard-card-icon">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="dashboard-card-content">
            <div class="dashboard-card-value">{{ stats.total|intcomma }}</div>
            <div class="dashboard-card-label">
                <span>Total subscriptions</span>
            </div>
        </div>
    </div>

    <div class="dashboard-card card-success">
        <div class="dashboard-card-header">
            <h4 class="dashboard-card-title">Active</h4>
            <div class="dashboard-card-icon">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="dashboard-card-content">
            <div class="dashboard-card-value">{{ stats.active|intcomma }}</div>
            <div class="dashboard-card-label">
                <span>Active status</span>
            </div>
        </div>
    </div>

    <div class="dashboard-card card-info">
        <div class="dashboard-card-header">
            <h4 class="dashboard-card-title">Trial</h4>
            <div class="dashboard-card-icon">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="dashboard-card-content">
            <div class="dashboard-card-value">{{ stats.trial|intcomma }}</div>
            <div class="dashboard-card-label">
                <span>Trial period</span>
            </div>
        </div>
    </div>

    <div class="dashboard-card card-primary">
        <div class="dashboard-card-header">
            <h4 class="dashboard-card-title">Expired</h4>
            <div class="dashboard-card-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
        </div>
        <div class="dashboard-card-content">
            <div class="dashboard-card-value">{{ stats.expired|intcomma }}</div>
            <div class="dashboard-card-label">
                <span>Expired subscriptions</span>
            </div>
        </div>
    </div>

    <div class="dashboard-card card-danger">
        <div class="dashboard-card-header">
            <h4 class="dashboard-card-title">Cancelled</h4>
            <div class="dashboard-card-icon">
                <i class="fas fa-ban"></i>
            </div>
        </div>
        <div class="dashboard-card-content">
            <div class="dashboard-card-value">{{ stats.cancelled|intcomma }}</div>
            <div class="dashboard-card-label">
                <span>Cancelled subscriptions</span>
            </div>
        </div>
    </div>
</div>

<!-- Filters Section -->
<div style="background: linear-gradient(135deg, rgba(26, 31, 58, 0.9) 0%, rgba(10, 14, 39, 0.95) 100%); border-radius: 16px; padding: 28px; margin-bottom: 32px; box-shadow: 0 0 40px rgba(0, 217, 255, 0.25), inset 0 0 20px rgba(0, 217, 255, 0.08); border: 1px solid var(--neon-blue); border-left: 5px solid var(--neon-cyan);">
    <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
        <h5 style="color: var(--neon-cyan); font-weight: 800; font-size: 18px; margin: 0; text-shadow: 0 0 15px rgba(0, 217, 255, 0.6); letter-spacing: 0.5px;">
            <i class="fas fa-search me-2"></i>Search & Filter Users
        </h5>
        <span style="background: rgba(0, 217, 255, 0.15); color: var(--neon-cyan); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; border: 1px solid rgba(0, 217, 255, 0.3);">
            <i class="fas fa-filter me-1"></i>Advanced Filters
        </span>
    </div>
    
    <form method="get" class="row g-3">
        <div class="col-lg-5 col-md-6">
            <label style="display: block; font-size: 12px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; text-shadow: 0 0 10px rgba(0, 217, 255, 0.4);">
                <i class="fas fa-user-search me-1"></i>Search Users
            </label>
            <input type="text" class="form-control" name="search" value="{{ search_query }}" placeholder="Username, email, or name..."
                   style="background: rgba(10, 14, 39, 0.8); border: 2px solid var(--neon-blue); color: var(--neon-cyan); font-weight: 500; padding: 12px 16px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 217, 255, 0.15); transition: all 0.3s ease;"
                   onfocus="this.style.boxShadow='0 0 25px rgba(0, 217, 255, 0.4)'; this.style.borderColor='var(--neon-cyan)';"
                   onblur="this.style.boxShadow='0 0 15px rgba(0, 217, 255, 0.15)'; this.style.borderColor='var(--neon-blue)';">
        </div>
        <div class="col-lg-3 col-md-6">
            <label style="display: block; font-size: 12px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; text-shadow: 0 0 10px rgba(0, 217, 255, 0.4);">
                <i class="fas fa-filter me-1"></i>Status
            </label>
            <select class="form-select" name="status"
                    style="background: rgba(10, 14, 39, 0.8); border: 2px solid var(--neon-blue); color: var(--neon-cyan); font-weight: 500; padding: 12px 16px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 217, 255, 0.15); transition: all 0.3s ease;"
                    onfocus="this.style.boxShadow='0 0 25px rgba(0, 217, 255, 0.4)'; this.style.borderColor='var(--neon-cyan)';"
                    onblur="this.style.boxShadow='0 0 15px rgba(0, 217, 255, 0.15)'; this.style.borderColor='var(--neon-blue)';">
                <option value="" style="background: #0A0E27; color: var(--neon-cyan);">All Statuses</option>
                <option value="active" {% if status_filter == 'active' %}selected{% endif %} style="background: #0A0E27; color: var(--neon-cyan);">Active</option>
                <option value="trial" {% if status_filter == 'trial' %}selected{% endif %} style="background: #0A0E27; color: var(--neon-cyan);">Trial</option>
                <option value="expired" {% if status_filter == 'expired' %}selected{% endif %} style="background: #0A0E27; color: var(--neon-cyan);">Expired</option>
                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %} style="background: #0A0E27; color: var(--neon-cyan);">Cancelled</option>
            </select>
        </div>
        <div class="col-lg-4 col-md-12">
            <label style="display: block; font-size: 12px; font-weight: 700; color: transparent; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Action</label>
            <div class="d-flex gap-2">
                <button type="submit" class="btn flex-grow-1" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border: none; font-weight: 700; padding: 12px 20px; border-radius: 10px; box-shadow: 0 0 25px rgba(0, 217, 255, 0.4); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 35px rgba(0, 217, 255, 0.6)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 25px rgba(0, 217, 255, 0.4)';">
                    <i class="fas fa-search me-2"></i>Search
                </button>
                <a href="{% url 'admin_dashboard:subscription_users' %}" class="btn" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; font-weight: 700; padding: 12px 20px; border-radius: 10px; box-shadow: 0 0 25px rgba(239, 68, 68, 0.4); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; text-decoration: none;"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 35px rgba(239, 68, 68, 0.6)';"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 25px rgba(239, 68, 68, 0.4)';">
                    <i class="fas fa-times me-2"></i>Clear
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Subscriptions Table -->
<div style="background: linear-gradient(135deg, rgba(26, 31, 58, 0.95) 0%, rgba(10, 14, 39, 0.98) 100%); border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 217, 255, 0.3); border: 2px solid rgba(0, 217, 255, 0.2);">
    <div style="background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(168, 85, 247, 0.15)); padding: 24px; border-bottom: 2px solid rgba(0, 217, 255, 0.3);">
        <h5 style="color: var(--neon-cyan); font-weight: 800; font-size: 20px; margin: 0; text-shadow: 0 0 15px rgba(0, 217, 255, 0.6);">
            <i class="fas fa-table me-2"></i>User Subscriptions
            {% if page_obj.paginator.count %}
                <span style="color: #A855F7; font-size: 18px;">({{ page_obj.paginator.count|intcomma }} total)</span>
            {% endif %}
        </h5>
    </div>
            
    {% if page_obj %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead style="background: rgba(0, 217, 255, 0.1); border-bottom: 2px solid rgba(0, 217, 255, 0.3);">
                <tr>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">User</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Plan</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Status</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Started</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Expires</th>
                    <th style="border: none; padding: 18px 20px; font-weight: 700; color: var(--neon-cyan); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for subscription in page_obj %}
                <tr style="border-bottom: 1px solid rgba(0, 217, 255, 0.1); transition: all 0.3s ease;" onmouseover="this.style.background='rgba(0, 217, 255, 0.05)';" onmouseout="this.style.background='transparent';">
                    <td style="padding: 18px 20px; border: none;">
                        <div class="d-flex align-items-center">
                            <div class="me-3" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);">
                                {{ subscription.user.username|first|upper }}
                            </div>
                            <div>
                                <div style="font-weight: 700; color: rgba(224, 231, 255, 0.95); font-size: 14px;">{{ subscription.user.username }}</div>
                                <small style="color: rgba(224, 231, 255, 0.5); font-size: 12px;">{{ subscription.user.email }}</small>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <span style="background: {% if subscription.plan.name == 'basic' %}rgba(100, 116, 139, 0.2){% elif subscription.plan.name == 'standard' %}rgba(251, 146, 60, 0.2){% else %}rgba(168, 85, 247, 0.2){% endif %}; 
                                    color: {% if subscription.plan.name == 'basic' %}#64748B{% elif subscription.plan.name == 'standard' %}#FB923C{% else %}#A855F7{% endif %}; 
                                    padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; border: 1px solid {% if subscription.plan.name == 'basic' %}rgba(100, 116, 139, 0.4){% elif subscription.plan.name == 'standard' %}rgba(251, 146, 60, 0.4){% else %}rgba(168, 85, 247, 0.4){% endif %};">
                            {{ subscription.plan.display_name }}
                        </span>
                        <br><small style="color: rgba(224, 231, 255, 0.5); font-size: 12px; margin-top: 4px; display: inline-block;">{{ subscription.plan.price_monthly|floatformat:0 }} RWF/month</small>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <span style="background: {% if subscription.status == 'active' %}rgba(34, 197, 94, 0.2){% elif subscription.status == 'trial' %}rgba(168, 85, 247, 0.2){% elif subscription.status == 'expired' %}rgba(100, 116, 139, 0.2){% else %}rgba(239, 68, 68, 0.2){% endif %}; 
                                    color: {% if subscription.status == 'active' %}#22C55E{% elif subscription.status == 'trial' %}#A855F7{% elif subscription.status == 'expired' %}#64748B{% else %}#EF4444{% endif %}; 
                                    padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; border: 1px solid {% if subscription.status == 'active' %}rgba(34, 197, 94, 0.4){% elif subscription.status == 'trial' %}rgba(168, 85, 247, 0.4){% elif subscription.status == 'expired' %}rgba(100, 116, 139, 0.4){% else %}rgba(239, 68, 68, 0.4){% endif %};">
                            {{ subscription.status|title }}
                        </span>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <div style="color: rgba(224, 231, 255, 0.9); font-size: 14px; font-weight: 600;">{{ subscription.created_at|date:"M d, Y" }}</div>
                        <small style="color: rgba(224, 231, 255, 0.5); font-size: 12px;">{{ subscription.created_at|timesince }} ago</small>
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        {% if subscription.end_date %}
                            <div style="color: rgba(224, 231, 255, 0.9); font-size: 14px; font-weight: 600;">{{ subscription.end_date|date:"M d, Y" }}</div>
                            <small style="color: rgba(224, 231, 255, 0.5); font-size: 12px;">in {{ subscription.end_date|timeuntil }}</small>
                        {% else %}
                            <span style="color: rgba(224, 231, 255, 0.4);">No expiry</span>
                        {% endif %}
                    </td>
                    <td style="padding: 18px 20px; border: none;">
                        <div class="d-flex gap-2">
                            <a href="/admin/payments/usersubscription/{{ subscription.id }}/change/" style="background: linear-gradient(135deg, #A855F7, #9333EA); color: white; border: none; font-weight: 700; padding: 8px 12px; border-radius: 8px; text-decoration: none; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(168, 85, 247, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(168, 85, 247, 0.3)';">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'admin_dashboard:subscription_payments' %}?user={{ subscription.user.id }}" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); color: var(--bg-darker); border: none; font-weight: 700; padding: 8px 12px; border-radius: 8px; text-decoration: none; box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 217, 255, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 217, 255, 0.3)';">
                                <i class="fas fa-receipt"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="p-3" style="background: rgba(212, 175, 55, 0.05); border-radius: 0 0 12px 12px;">
                <nav aria-label="Subscriptions pagination">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ page_obj.previous_page_number }}" style="color: var(--chocolate-dark);">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link" style="background: var(--gold); border-color: var(--gold); color: var(--chocolate-dark);">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ num }}" style="color: var(--chocolate-dark);">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ page_obj.next_page_number }}" style="color: var(--chocolate-dark);">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <div class="text-center p-5">
                <i class="fas fa-users fa-3x mb-3" style="color: var(--gold);"></i>
                <h5 style="color: var(--chocolate-dark);">No subscriptions found</h5>
                <p class="text-muted">
                    {% if search_query or status_filter %}
                        No subscriptions match your current filters.
                    {% else %}
                        No user subscriptions have been created yet.
                    {% endif %}
                </p>
                {% if search_query or status_filter %}
                <a href="{% url 'admin_dashboard:subscription_users' %}" class="btn" style="background: var(--gold); color: var(--chocolate-dark); border: none; font-weight: bold; padding: 10px 20px; border-radius: 6px;">
                    <i class="fas fa-times me-1"></i> Clear Filters
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}